# Week6-è„šæ‰‹æ¶é¡¹ç›®å’Œç»„ä»¶åˆå§‹åŒ–å¼€å‘

### ç¬¬ä¸€ç« ï¼šæœ¬å‘¨å¯¼å­¦

---

#### 1-1 æœ¬å‘¨æ•´ä½“å†…å®¹ä»‹ç»å’Œå­¦ä¹ æ–¹æ³•
> - é‡ç‚¹ï¼šè„šæ‰‹æ¶å®‰è£… é¡¹ç›®/ç»„ä»¶  åŠŸèƒ½å¼€å‘ã€‚
> - æŠ€æœ¯æ ˆï¼šejsæ¨¡ç‰ˆæ¸²æŸ“(é¡¹ç›®æ¨¡æ¿å®‰è£…)å’Œglobæ–‡ä»¶ç­›é€‰ã€‚
> - åŠ é¤ï¼šejsæºç è§£æã€requireæºç è§£æã€‚ 



### ç¬¬äºŒç« ï¼šè„šæ‰‹æ¶å®‰è£…æ¨¡ç‰ˆåŠŸèƒ½æ¶æ„è®¾è®¡

---



#### 2-1 è„šæ‰‹æ¶å®‰è£…é¡¹ç›®æ¨¡æ¿æ¶æ„è®¾è®¡
installTemplate
![image.png](./images/0601.jpg)

#### 2-2 è„šæ‰‹æ¶ç»„ä»¶åˆå§‹åŒ–æ¶æ„è®¾è®¡


> ä¸é¡¹ç›®å¤§ä½“è¿‡ç¨‹æ²¡æœ‰æ”¹å˜ã€‚
> tiny changeï¼š
> - æ–‡æœ¬æç¤ºåç§°
> - é¡¹ç›®åç§°format
> - ç»„ä»¶éœ€è¦å¡«å†™æè¿°ä¿¡æ¯



### ç¬¬ä¸‰ç«  è„šæ‰‹æ¶æ¨¡æ¿å®‰è£…æ ¸å¿ƒå®ç°ï¼šejs åº“åŠŸèƒ½è¯¦è§£

---

#### 3-1 ejsæ¨¡æ¿å¼•æ“çš„ä¸‰ç§åŸºæœ¬ç”¨æ³•


> ejsä¸»è¦ç”¨äºæ¨¡ç‰ˆæ¸²æŸ“çš„ã€‚jspã€phpæ˜¯ä¹‹å‰æ¨¡ç‰ˆæ¸²æŸ“çš„ä»£è¡¨ã€‚ejsçš„å®ç°ä¸jspéå¸¸ç±»ä¼¼ã€‚
> - ejs.compile(html,options)(data)



```javascript
const ejs = require('ejs')
const path = require('path')
//ç¬¬ä¸€ç§æ–¹æ³•
const html ='<div><%= user.name%></div>'
const options = {}
const data ={
    user:{
        name:'liugezhou'
    }
}

const template = ejs.compile(html,options) //// è¿”å›ä¸€ä¸ªç”¨äºè§£æhtmlä¸­æ¨¡æ¿çš„ function

const compileTemplate = template(data)

console.log(compileTemplate)   //<div>liugezhou</div>

//ç¬¬äºŒç§ç”¨æ³•
const renderTemplate = ejs.render(html,data,options)
console.log(renderTemplate)

//ç¬¬ä¸‰ç§ç”¨æ³•
const renderFile = ejs.renderFile(path.resolve(__dirname,'template.html'),data,options)
renderFile.then(file => console.log(file))

```


#### 3-2 ejsæ¨¡æ¿ä¸åŒæ ‡ç­¾ç”¨æ³•è¯¦è§£

> - <%   : â€˜è„šæœ¬â€™æ ‡ç­¾ï¼Œç”¨äºæµç¨‹æ§åˆ¶ï¼Œæ— è¾“å‡ºã€‚
> - <%= : è¾“å‡ºæ•°æ®åˆ°æ¨¡ç‰ˆ(è¾“å‡ºæ˜¯è½¬ä¹‰Htmlæ ‡ç­¾)
> - <%- : è¾“å‡ºéè½¬ä¹‰çš„æ•°æ®åˆ°æ¨¡ç‰ˆ :å¦‚æœæ•°æ®æ˜¯<div>liugehou</div>,é‚£ä¹ˆè¾“å‡ºçš„å°±æ˜¯è¿™æ ·çš„æ ¼å¼ã€‚
> - <%# : æ³¨é‡Šæ ‡ç­¾ï¼Œä¸æ‰§è¡Œã€ä¸è¾“å‡ºå†…å®¹ï¼Œä½†æ˜¯ä¼šå ç©ºé—´ã€‚
> - <%_ : åˆ é™¤å‰é¢ç©ºæ ¼ç©ºç¬¦
> - -%>: åˆ é™¤ç´§éšå…¶åçš„æ¢è¡Œç¬¦
> - _%>: åˆ é™¤åé¢ç©ºæ ¼å­—ç¬¦



#### 3-3 ejsæ¨¡æ¿å‡ ç§ç‰¹æ®Šç”¨æ³•


> æœ¬èŠ‚ä¸»è¦ä»‹ç»ejså¦å¤–æ¯”è¾ƒå¸¸ç”¨çš„ä¸‰ä¸ªè¾…åŠ©åŠŸèƒ½
> - åŒ…å«: include
> - è‡ªå®šä¹‰åˆ†éš”ç¬¦: æˆ‘ä»¬ä¸Šé¢é»˜è®¤ä½¿ç”¨çš„æ˜¯%ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨optionså‚æ•°ä¸­å®šä¹‰ delimiterè¿™ä¸ªå‚æ•°å³å¯
> - è‡ªå®šä¹‰æ–‡ä»¶åŠ è½½å™¨: åœ¨ä½¿ç”¨ejs.renderFileè¯»å–æ–‡ä»¶ä¹‹å‰ï¼Œå¯ä»¥ä½¿ç”¨ejs.fileLoaderåšä¸€äº›æ“ä½œ

```javascript
ejs.fileLoader = function(filePath){
	const content = fs.readFileSync(filePath)
  return '<div><%= user.copyright %></div>' + content
}
```



#### 3-4 globç”¨æ³•å°ç»“


> globæœ€æ—©æ˜¯å‡ºç°åœ¨ç±»Unixç³»ç»Ÿçš„å‘½ä»¤ä¸­çš„ï¼Œç”¨æ¥åŒ¹é…æ–‡ä»¶è·¯å¾„ã€‚ 

```javascript
const glob = require('glob')

glob('**/*.js',{ignore:['node_modules/**','webpack.config.js']},function(err,file){
    console.log(file)
})
```


### ç¬¬å››ç« ï¼šè„šæ‰‹æ¶é¡¹ç›®æ¨¡æ¿å®‰è£…åŠŸèƒ½å¼€å‘

---

#### 4-1 å¼•å…¥é¡¹ç›®æ¨¡æ¿ç±»å‹å’Œæ ‡å‡†å®‰è£…é€»è¾‘å¼€å‘

> æœ¬èŠ‚ä»£ç è¾ƒå°‘ï¼Œä¸»è¦æ˜¯æ¢³ç†æµç¨‹ï¼Œä¸Šä¸€å¤§å‘¨å†™åˆ°äº†ä¸‹è½½æ¨¡ç‰ˆåˆ°æœ¬åœ°ç¼“å­˜ï¼Œæœ¬èŠ‚æ¥ç€ä¸Šå‘¨è¿›åº¦ï¼š
> æ¥ç€ä¾¿éœ€è¦å®‰è£…æ¨¡ç‰ˆï¼Œæ–°å»ºäº†å®‰è£…æ¨¡ç‰ˆ installTemplate()æ–¹æ³•ï¼Œå¹¶å¯¹æ‹¿åˆ°æ¨¡ç‰ˆçš„typeè¿›è¡Œåˆ¤æ–­ï¼Œ
> è‹¥ä¸ºnormalï¼Œåˆ™æ‰§è¡Œå®‰è£…æ ‡å‡†æ¨¡ç‰ˆæ–¹æ³•ï¼šinstallNormalTemplate()
> è‹¥ä¸ºcustomï¼Œåˆ™æ‰§è¡Œå®‰è£…è‡ªå®šä¹‰æ¨¡ç‰ˆæ–¹æ³•ï¼šinstallCustomTemplate()



#### 4-2 æ‹·è´é¡¹ç›®æ¨¡æ¿åŠŸèƒ½å¼€å‘
```javascript
async installNormalTemplate(){
  //æ‹·è´æ¨¡æ¿ä»£ç è‡³å½“å‰ç›®å½•
  const spinner = spinnerStart('æ­£åœ¨å®‰è£…æ¨¡æ¿...')
  await sleep()
  try {
    // å»ç¼“å­˜ç›®å½•ä¸­æ‹¿templateä¸‹çš„æ–‡ä»¶è·¯å¾„
    const templatePath = path.resolve(this.templateNpm.cacheFilePath,'template')
    //å½“å‰æ‰§è¡Œè„šæ‰‹æ¶ç›®å½•
    const targetPath = process.cwd()
    fse.ensureDirSync(templatePath)//ç¡®ä¿ä½¿ç”¨å‰ç¼“å­˜ç”Ÿæˆç›®å½•å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º
    fse.ensureDirSync(targetPath)   //ç¡®ä¿å½“å‰è„šæ‰‹æ¶å®‰è£…ç›®å½•å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º
    fse.copySync(templatePath,targetPath) //å°†ç¼“å­˜ç›®å½•ä¸‹æ–‡ä»¶copyè‡³å½“å‰ç›®å½•
  } catch (error) {
    throw error
  } finally{ 
    spinner.stop(true)
    log.success('æ¨¡æ¿å®‰è£…æˆåŠŸ')
  }
}
```
#### 
#### 4-3 é¡¹ç›®æ¨¡æ¿å®‰è£…ä¾èµ–å’Œå¯åŠ¨å‘½ä»¤ | **4-4 ç™½åå•å‘½ä»¤æ£€æµ‹åŠŸèƒ½å¼€å‘**

<br />åœ¨ä¸Šä¸€èŠ‚ï¼Œæ¨¡æ¿copyæˆåŠŸä¹‹åï¼Œç´§æ¥ç€ï¼š

```javascript
//ä¾èµ–å®‰è£…
const { installCommand,startCommand } = this.templateInfo
//ä¾èµ–å®‰è£…
await this.execCommand(installCommand,'ä¾èµ–è¿‡ç¨‹å®‰è£…å¤±è´¥ï¼')
//å¯åŠ¨å‘½ä»¤æ‰§è¡Œ
await this.execCommand(startCommand,'å¯åŠ¨å‘½ä»¤æ‰§è¡Œå¤±è´¥å¤±è´¥ï¼')
```

```javascript
const WHITE_COMMAND =['npm', 'cnpm'] 

async execCommand(command,errMsg){
        let ret 
        if(command){
            const cmdArray=command.split(' ')
            const cmd = this.checkCommand(cmdArray[0])
            if(!cmd){
                throw new Error(errMsg)
            }
            const args = cmdArray.slice(1)
            ret = await execAsync(cmd,args,{
                stdio:'inherit',
                cwd:process.cwd()
            })
            if(ret !== 0){//æ‰§è¡ŒæˆåŠŸ
                throw new Error('ä¾èµ–å®‰è£…è¿‡ç¨‹å¤±è´¥')
            }
            return ret
        }
    }
    checkCommand(cmd){
        if(WHITE_COMMAND.includes(cmd)){
            return cmd
        }
        return null;
    }
```

#### 4-5 é¡¹ç›®åç§°è‡ªåŠ¨æ ¼å¼åŒ–åŠŸèƒ½å¼€å‘


> æœ¬èŠ‚ä½¿ç”¨äº†kebab-caseè¿™ä¸ªåº“ï¼Œå°†æ‰‹åŠ¨å¡«å…¥çš„é¡¹ç›®åç§°ä¿å­˜åœ¨projectInfoä¸­ï¼Œä»¥ä¾›åç»­package.jsonä¸­çš„ejsæ¸²æŸ“ä½¿ç”¨ã€‚

```javascript
//ç”ŸæˆclassName
if(projectInfo.projectName){
  projectInfo.name = projectInfo.projectName
  projectInfo.className = require('kebab-case')(projectInfo.projectName).replace(/^-/,'');
}
if(projectInfo.projectVersion){
  projectInfo.version = projectInfo.projectVersion
}
```

#### 4-6 æœ¬ç« æ ¸å¿ƒï¼šejsåŠ¨æ€æ¸²æŸ“é¡¹ç›®æ¨¡æ¿


> - é¦–å…ˆå°†vue2æ¨¡ç‰ˆä¸­package.jsonæ–‡ä»¶ä¸­çš„nameä»¥åŠversionä½¿ç”¨<%= className%>å’Œ<%= version%>æ›¿ä»£ï¼Œå¹¶å‘å¸ƒæ–°çš„ç‰ˆæœ¬è‡³npmã€‚
> - commands/initæ¨¡å—å®‰è£… ejså’Œglobåº“ã€‚
> - æ ¸å¿ƒä»£ç å¦‚ä¸‹(åœ¨4-4èŠ‚ä¸­ä¾èµ–å®‰è£…å‰ï¼ŒejsåŠ¨æ€æ¸²æŸ“)

```javascript
 async ejsRender(options){
   const dir = process.cwd()
   const projectInfo = this.projectInfo
   return new Promise((resolve,reject)=>{
     glob('**',{
       cwd:dir,
       ignore:options.ignore || '',
       nodir:true   //ä¸è¾“å‡ºæ–‡ä»¶å¤¹ï¼Œåªè¾“å‡ºæ–‡ä»¶
     },(err,files) =>{
       if(err){
         reject(err)
       }
       Promise.all(files.map(file=>{
         const filePath = path.join(dir,file)
         return new Promise( (resolve1,reject1) => {
           ejs.renderFile( filePath,projectInfo,{},(err,result) => {
             if(err){
               reject1(err)
             }
             fse.writeFileSync(filePath,result)
             resolve1(result)
           })
         })
       })).then(()=>{
         resolve()
       }).catch(err=>{
         reject(err)
       })
     })
   })
 }
```

#### 4-7 initå‘½ä»¤ç›´æ¥ä¼ å…¥é¡¹ç›®åç§°åŠŸèƒ½æ”¯æŒ
> æœ¬èŠ‚å®Œæˆçš„æ˜¯  å¯¹å‘½ä»¤è¡Œä¸­ä¼ å…¥é¡¹ç›®åç§°çš„ä¸€ä¸ªæ”¯æŒ
> é€šè¿‡åˆ¤æ–­è„šæ‰‹æ¶å‘½ä»¤æ˜¯å¦ä¼ å…¥é¡¹ç›®åç§°ï¼Œå¯¹inquirerä¸­çš„promptè¿›è¡ŒåŠ¨æ€pushã€‚


### ç¬¬äº”ç«  ç»„ä»¶æ¨¡æ¿å¼€å‘åŠè„šæ‰‹æ¶ç»„ä»¶åˆå§‹åŒ–åŠŸèƒ½æ”¯æŒ

---


#### 5-1 æ…•è¯¾ä¹é«˜ç»„ä»¶åº“æ¨¡æ¿å¼€å‘

> ç»´æŠ¤ç»„ä»¶åº“å‘å¸ƒè‡³npmï¼Œç„¶ååœ¨mongodbæ•°æ®åº“ä¸­è¿›è¡Œé…ç½®ã€‚

#### 5-2 é¡¹ç›®å’Œç»„ä»¶æ¨¡æ¿æ•°æ®éš”ç¦»+åŠ¨æ€é…ç½®ejs ignore


  è¿™éƒ¨åˆ†å®Œæ•´ä»£ç å¦‚ä¸‹
```javascript
 //1.é€‰å–åˆ›å»ºé¡¹ç›®æˆ–ç»„ä»¶
const { type } = await inquirer.prompt({
  type:'list',
  name:'type',
  message:'è¯·é€‰æ‹©åˆå§‹åŒ–ç±»å‹', 
  default:TYPE_PROJECT,
  choices: [{
    name: 'é¡¹ç›®',
    value: TYPE_PROJECT,
  }, {
    name: 'ç»„ä»¶',
    value: TYPE_COMPONENT,
  }]
})

// æ•°æ®éš”ç¦»æ ¸å¿ƒä»£ç 
this.template = this.template.filter(template =>template.tag && template.tag.includes(type))

const title =  type === TYPE_PROJECT ? 'é¡¹ç›®':'ç»„ä»¶'
const projectNamePrompt = {
  type:'input',
  name:'projectName',
  message:`è¯·è¾“å…¥${title}çš„åç§°`,
  default:'',
  validate:function(v){
    const done = this.async()
    setTimeout(function(){
      if(!isValidName(v)){
        done(`è¯·è¾“å…¥åˆæ³•çš„${title}åç§°`)
        return;
      }
      done(null,true)
    }, 0);
  },
  filter:function(v){
    return v
  }
}
const projectPrompt = []
if (!isProjectNameValid) {
  projectPrompt.push(projectNamePrompt);
}
projectPrompt.push({
  type:'input',
  name:'projectVersion',
  default:'1.0.0',
  message:`è¯·è¾“å…¥${title}ç‰ˆæœ¬å·`,
  validate:function(v){
    const done = this.async();
    // Do async stuff
    setTimeout(function() {
      if (!(!!semver.valid(v))) {
        done(`è¯·è¾“å…¥åˆæ³•çš„${title}ç‰ˆæœ¬å·`);
        return;
      }
      done(null, true);
    }, 0);
  },
  filter:function(v){
    if(semver.valid(v)){
      return semver.valid(v)
    } else {
      return v
    }
  },
},{
  type:'list',
  name:'projectTemplate',
  message:`è¯·é€‰æ‹©${title}æ¨¡æ¿`,
  choices: this.createTemplateChoice()
})
```

#### 5-3 è·å–ç»„ä»¶ä¿¡æ¯åŠŸèƒ½å¼€å‘

å®Œæ•´æ ¸å¿ƒä»£ç å¦‚ä¸‹,æ·»åŠ äº† descriptionPrompt


```javascript
else if (type === TYPE_COMPONENT){
  // è·å–ç»„ä»¶çš„åŸºæœ¬ä¿¡æ¯
  const descriptionPrompt = {
    type:'input',
    name:'componentDescription',
    message:'è¯·è¾“å…¥ç»„ä»¶æè¿°ä¿¡æ¯',
    default:'',
    validate:function(v){
      const done = this.async()
      setTimeout(() => {
        if(!v){
          done('è¯·è¾“å…¥ç»„ä»¶æè¿°ä¿¡æ¯')
          return 
        }
        done(null,true)
      }, 0);
    }
  }
  projectPrompt.push(descriptionPrompt)
  const component = await inquirer.prompt(projectPrompt)
  projectInfo = {
    ...projectInfo,
    type,
    ...component
  }
}

â€¦â€¦
if(projectInfo.componentDescription){
  projectInfo.description = projectInfo.componentDescription
}

```


#### 5-4 è§£å†³ç»„ä»¶åº“åˆå§‹åŒ–è¿‡ç¨‹ä¸­å„ç§å·¥ç¨‹é—®é¢˜
**
> æ…•è¯¾ä¹é«˜ç»„ä»¶åº“ï¼Œåœ¨å‘å¸ƒåˆ°npmåŒ…æ—¶ï¼Œå®‰è£…å‡ºç°é—®é¢˜ï¼Œé—®é¢˜åŸå› æ˜¯ package.jsonä¸­ï¼Œéœ€è¦å°†
> "files":['dist']  è¿™è¡Œä»£ç å»é™¤ï¼Œè¿™æ˜¯å› ä¸ºfilesè¿™é‡Œé™å®šäº†ä¸Šä¼ å‘å¸ƒåˆ°npmååªæœ‰distè¿™ä¸ªç›®å½•ã€‚



### ç¬¬å…­ç«  è„šæ‰‹æ¶è‡ªå®šä¹‰åˆå§‹åŒ–é¡¹ç›®æ¨¡æ¿åŠŸèƒ½å¼€å‘

---



#### 6-1 è‡ªå®šä¹‰é¡¹ç›®æ¨¡æ¿å¼€å‘


> - å‘å¸ƒè‡ªå®šä¹‰æ¨¡ç‰ˆ [liugezhou-cli-dev-template-custom-vue2](https://www.npmjs.com/package/liugezhou-cli-dev-template-custom-vue2)
> - mongodbä¸­é…ç½®è‡ªå®šä¹‰æ¨¡ç‰ˆæ•°æ®ã€‚



#### 6-2 è‡ªå®šä¹‰æ¨¡æ¿æ‰§è¡Œé€»è¾‘å¼€å‘
#### 6-3 è‡ªå®šä¹‰æ¨¡æ¿ä¸Šçº¿
```javascript
async installCustomTemplate(){
        //æŸ¥è¯¢è‡ªå®šä¹‰æ¨¡ç‰ˆçš„å…¥å£æ–‡ä»¶
  if(await this.templateNpm.exists()){
    const rootFile = this.templateNpm.getRootFilePath()
    if(fs.existsSync(rootFile)){
      log.verbose('å¼€å§‹æ‰§è¡Œè‡ªå®šä¹‰æ¨¡æ¿')
      const templatePath = path.resolve(this.templateNpm.cacheFilePath, 'template');
      const options = {
        templateInfo: this.templateInfo,
        projectInfo: this.projectInfo,
        sourcePath: templatePath,
        targetPath: process.cwd(),
      };
      const code = `require('${rootFile}')(${JSON.stringify(options)})`
      await execAsync('node',  ['-e', code], {stdio:'inherit',cwd: process.cwd()})
      log.success('è‡ªå®šä¹‰æ¨¡ç‰ˆå®‰è£…æˆåŠŸ')
    }else{
      throw new Error('è‡ªå®šä¹‰æ¨¡æ¿å…¥å£æ–‡ä»¶ä¸å­˜åœ¨')
    }
  }
}
```
### 
### ç¬¬ä¸ƒç«  æœ¬å‘¨åŠ é¤ï¼šejs åº“æºç è§£æ â€”â€” å½»åº•ææ‡‚æ¨¡æ¿åŠ¨æ€æ¸²æŸ“åŸç†

---

#### 7-1 ejs.compileæ‰§è¡Œæµç¨‹åˆ†æ
> ejsæ¨¡ç‰ˆæ¸²æŸ“çš„æ€è·¯å€¼å¾—æˆ‘ä»¬å­¦ä¹ ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¼€å§‹äº†äº†ejsçš„æºç çš„å­¦ä¹ ã€‚ 

![image.png](./images/0602.png)

> æœ¬èŠ‚å†…å®¹è¾ƒç®€å•ï¼Œæˆ‘ä»¬æ‰“å¼€webstoreï¼Œä»ä¸‹é¢çš„ä»£ç å¼€å§‹è°ƒè¯•ï¼ˆ11è¡Œ æ‰“æ–­ç‚¹ï¼‰

```javascript
const ejs = require('ejs')

const html = '<div><%= user.name %></div>'
const options = {}
const data = {
	user:{
    name:'liugezhou'
  }
}

const template = ejs.compile(html,options)
const compiletemplate = template(data)
```
```javascript
//ejs.js
exports.compile = function compile(template, opts) {
  var templ;
  if (opts && opts.scope) {   //æˆ‘ä»¬çš„optsä¼ è¿›æ¥çš„å‚æ•°ä¸ºç©ºï¼Œæš‚ä¸çœ‹æ­¤åˆ¤æ–­é€»è¾‘
    â€¦â€¦
  }
  templ = new Template(template, opts);
  return templ.compile();
};
```

> templ = new Template(template,opts)   æˆ‘ä»¬ç»§ç»­è¿›å»æºç ï¼Œé‡è¦çš„æœ‰ä¸¤ç‚¹
> - this.templateText = text
> - this.regex = this.createRegex()
> 


> ä¸‹èŠ‚å¼€å§‹ templ.compile()

```javascript
function Template(text, opts) {
  opts = opts || {};
  var options = {};
  this.templateText = text;    //â­ï¸â­ï¸â­ï¸
  this.mode = null;
  this.truncate = false;
  this.currentLine = 1;
  this.source = '';
  options.client = opts.client || false;
  options.escapeFunction = opts.escape || opts.escapeFunction || utils.escapeXML;
  options.compileDebug = opts.compileDebug !== false;
  options.debug = !!opts.debug;
  options.filename = opts.filename;
  options.openDelimiter = opts.openDelimiter || exports.openDelimiter || _DEFAULT_OPEN_DELIMITER;
  options.closeDelimiter = opts.closeDelimiter || exports.closeDelimiter || _DEFAULT_CLOSE_DELIMITER;
  options.delimiter = opts.delimiter || exports.delimiter || _DEFAULT_DELIMITER;
  options.strict = opts.strict || false;
  options.context = opts.context;
  options.cache = opts.cache || false;
  options.rmWhitespace = opts.rmWhitespace;
  options.root = opts.root;
  options.includer = opts.includer;
  options.outputFunctionName = opts.outputFunctionName;
  options.localsName = opts.localsName || exports.localsName || _DEFAULT_LOCALS_NAME;
  options.views = opts.views;
  options.async = opts.async;
  options.destructuredLocals = opts.destructuredLocals;
  options.legacyInclude = typeof opts.legacyInclude != 'undefined' ? !!opts.legacyInclude : true;

  if (options.strict) {
    options._with = false;
  }
  else {
    options._with = typeof opts._with != 'undefined' ? opts._with : true;
  }

  this.opts = options;

  this.regex = this.createRegex();  // â­ï¸â­ï¸â­ï¸ï¼šè¯¥æ–¹æ³•æ˜¯å¯¹ejsæ ‡è¯†ç¬¦å·%ä¸å¼€å§‹ç»“å°¾ç¬¦å·<>ï¼Œè¿›è¡Œå®šåˆ¶åŒ–æ“ä½œ
}

```
#### 
#### 7-2 æ·±å…¥è®²è§£ejsç¼–è¯‘åŸç†
> ä¸Šä¸€èŠ‚æˆ‘ä»¬çœ‹åˆ°äº† return templet.compile()å¤„ï¼Œæºä»£ç å¦‚ä¸‹

```javascript
  compile: function () {
 
    var src;
    var fn;
    var opts = this.opts;
    var prepended = '';
    var appended = '';
    var escapeFn = opts.escapeFunction;
    var ctor;
    var sanitizedFilename = opts.filename ? JSON.stringify(opts.filename) : 'undefined';

    if (!this.source) {
      this.generateSource();   //â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸
      prepended +=
        '  var __output = "";\n' +
        '  function __append(s) { if (s !== undefined && s !== null) __output += s }\n';
      if (opts.outputFunctionName) {
        prepended += '  var ' + opts.outputFunctionName + ' = __append;' + '\n';
      }
      if (opts.destructuredLocals && opts.destructuredLocals.length) {
        var destructuring = '  var __locals = (' + opts.localsName + ' || {}),\n';
        for (var i = 0; i < opts.destructuredLocals.length; i++) {
          var name = opts.destructuredLocals[i];
          if (i > 0) {
            destructuring += ',\n  ';
          }
          destructuring += name + ' = __locals.' + name;
        }
        prepended += destructuring + ';\n';
      }
      if (opts._with !== false) {
        prepended +=  '  with (' + opts.localsName + ' || {}) {' + '\n';
        appended += '  }' + '\n';
      }
      appended += '  return __output;' + '\n';
      this.source = prepended + this.source + appended;
    }

    if (opts.compileDebug) {
      src = 'var __line = 1' + '\n'
        + '  , __lines = ' + JSON.stringify(this.templateText) + '\n'
        + '  , __filename = ' + sanitizedFilename + ';' + '\n'
        + 'try {' + '\n'
        + this.source
        + '} catch (e) {' + '\n'
        + '  rethrow(e, __lines, __filename, __line, escapeFn);' + '\n'
        + '}' + '\n';
    }
    else {
      src = this.source;
    }

    if (opts.client) {
      src = 'escapeFn = escapeFn || ' + escapeFn.toString() + ';' + '\n' + src;
      if (opts.compileDebug) {
        src = 'rethrow = rethrow || ' + rethrow.toString() + ';' + '\n' + src;
      }
    }

    if (opts.strict) {
      src = '"use strict";\n' + src;
    }
    if (opts.debug) {
      console.log(src);
    }
    if (opts.compileDebug && opts.filename) {
      src = src + '\n'
        + '//# sourceURL=' + sanitizedFilename + '\n';
    }

    try {
      if (opts.async) {
        try {
          ctor = (new Function('return (async function(){}).constructor;'))();
        }
        catch(e) {
          if (e instanceof SyntaxError) {
            throw new Error('This environment does not support async/await');
          }
          else {
            throw e;
          }
        }
      }
      else {
        ctor = Function;
      }
      fn = new ctor(opts.localsName + ', escapeFn, include, rethrow', src);
    }
    catch(e) {
      // istanbul ignore else
      if (e instanceof SyntaxError) {
        if (opts.filename) {
          e.message += ' in ' + opts.filename;
        }
        e.message += ' while compiling ejs\n\n';
        e.message += 'If the above error is not helpful, you may want to try EJS-Lint:\n';
        e.message += 'https://github.com/RyanZim/EJS-Lint';
        if (!opts.async) {
          e.message += '\n';
          e.message += 'Or, if you meant to create an async function, pass `async: true` as an option.';
        }
      }
      throw e;
    }

    var returnedFn = opts.client ? fn : function anonymous(data) {
      var include = function (path, includeData) {
        var d = utils.shallowCopy({}, data);
        if (includeData) {
          d = utils.shallowCopy(d, includeData);
        }
        return includeFile(path, opts)(d);
      };
      return fn.apply(opts.context, [data || {}, escapeFn, include, rethrow]);
    };
    if (opts.filename && typeof Object.defineProperty === 'function') {
      var filename = opts.filename;
      var basename = path.basename(filename, path.extname(filename));
      try {
        Object.defineProperty(returnedFn, 'name', {
          value: basename,
          writable: false,
          enumerable: false,
          configurable: true
        });
      } catch (e) {/* ignore */}
    }
    return returnedFn;
  },

```

**generateSourceï¼šï¼ˆæœ€ç»ˆæ‹¿åˆ°ç»“æœthis.sourceï¼‰**
```javascript
 generateSource: function () {
    var opts = this.opts;


    // Slurp spaces and tabs before <%_ and after _%>
    this.templateText =
      this.templateText.replace(/[ \t]*<%_/gm, '<%_').replace(/_%>[ \t]*/gm, '_%>');

    var self = this;
    var matches = this.parseTemplateText();    //â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸
    var d = this.opts.delimiter;
    var o = this.opts.openDelimiter;
    var c = this.opts.closeDelimiter;

    if (matches && matches.length) {
      matches.forEach(function (line, index) {   //â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸
        var closing;
        if ( line.indexOf(o + d) === 0        // If it is a tag
          && line.indexOf(o + d + d) !== 0) { // and is not escaped
          closing = matches[index + 2];
          if (!(closing == d + c || closing == '-' + d + c || closing == '_' + d + c)) {
            throw new Error('Could not find matching close tag for "' + line + '".');
          }
        }
        self.scanLine(line); ////â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸
      });
    }

  },

```

#### 7-3 åŠ¨æ€ç”ŸæˆFunction+withç”¨æ³•è®²è§£
> ä¸Šä¸€èŠ‚ä»£ç æ²¡æœ‰ç»§ç»­è¿½è¸ªï¼Œæ ¹æ®è‡ªå·±çš„æºç ä¸€æ­¥ä¸€æ­¥è°ƒè¯•ï¼Œç”Ÿä¸€èŠ‚è°ƒè¯•åˆ°çš„ä»£ç ä¸ºï¼š

```javascript
// ejs.js  line662
fn = new ctor(opts.localsName + ', escapeFn, include, rethrow', src);
```


> ä»£ç è®²è§£ï¼š
> const ctor = Function;
> const fn = new ctor('a,b','console.log(a,b)')
> fn(1,2)

> æˆ‘ä»¬å›åˆ°7-1èŠ‚ä¸­åŸºç¡€ä»£ç ï¼Œåœ¨optonsåŠ å…¥å‚æ•°debugä¸ºtrueï¼Œæ§åˆ¶å°è¾“å‡ºå†…å®¹ä¸ºï¼š

```javascript
var __line = 1
  , __lines = "<div><%= user.name%></div>"
  , __filename = undefined;
try {
  var __output = "";
  function __append(s) { if (s !== undefined && s !== null) __output += s }
  with (locals || {}) {
    ; __append("<div>")
    ; __append(escapeFn( user.name))
    ; __append("</div>")
  }
  return __output;
} catch (e) {
  rethrow(e, __lines, __filename, __line, escapeFn);
}

```

> é€šè¿‡ä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†â€˜withâ€™ï¼Œç°åœ¨å‰ç«¯withçš„ä½¿ç”¨å·²ç»å¾ˆä¸å¸¸è§ä¸”ä¸æ¨èä½¿ç”¨äº†ï¼Œè¿™é‡Œç®€å•äº†è§£ä¸‹ï¼š

```javascript
const ctx = {
	user:{
  	name:'liugezhou'
  }
} 

with(ctx){
  console.log(user.name)   
}
```


#### 7-4 ejs compileå‡½æ•°æ‰§è¡Œæµç¨‹åˆ†æ

> applyç®€è¦è§£é‡Š

```javascript
function test(a,b,c){
	console.log(a,b,c)
  console.log(this.a)
}
test(1,2,3) //é€šå¸¸è°ƒç”¨   // 1 2 3

test.apply({a:'applt'},[2,3,4]) // 2 3 4 
test.call({a:'call',2,3,4)    // 2 3 4
```


#### 7-5 ejs.renderå’ŒrenderFileåŸç†è®²è§£

ejs.renderçš„ä»£ç æ‰§è¡Œæµç¨‹ä¸ºï¼š
> - const renderTemplate = ejs.render(html,data,options)
> - exports.render ==> handleCache(opts, template)
> - handleCache ==>  return  exports.compile(template, options);
> - handleCache(opts, template)(data)


renderFileçš„åŸç†è®²è§£
> 1. const renderFile = ejs.renderFile(**path**.resolve(__dirname,'template.html'),data,options)
> 1. exports.renderFile
> 1. tryHandleCache(opts, data, cb)
> 1. handleCache(options)(data)


### ç¬¬å…«ç«  åŠ é¤ï¼šrequireæºç è§£æï¼Œå½»åº•ææ‡‚ npm æ¨¡å—åŠ è½½åŸç†

---

#### 8-1 requireæºç æ‰§è¡Œæµç¨‹åˆ†æ

- **requireä½¿ç”¨åœºæ™¯**

> - åŠ è½½æ¨¡å—ç±»å‹
>    - åŠ è½½å†…ç½®æ¨¡å—ï¼š require('fs')
>    - åŠ è½½node_modulesæ¨¡å—ï¼šrequire('ejs')
>    - åŠ è½½æœ¬åœ°æ¨¡å—ï¼šrequire('./utils')
> - æ”¯æŒåŠ è½½æ–‡ä»¶
>    - js
>    - json
>    - node
>    - mjs
>    - åŠ è½½å…¶å®ƒç±»å‹


- **requireæ‰§è¡Œæµç¨‹**

![image.png](./images/0603.png)

> æˆ‘ä»¬åœ¨è°ƒè¯•è¿™è¡Œä»£ç çš„æ—¶å€™ï¼Œåœ¨æ‰§è¡Œæ ˆä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¹‹å‰ä¹Ÿæ‰§è¡Œäº†å¾ˆå¤šä»£ç ï¼Œè¿™é‡Œçš„æµç¨‹ä»¥åŠä¸Šé¢åˆ†æçš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¼•å‡ºä¸€äº›æ€è€ƒï¼š
> - CommonJSæ¨¡å—çš„åŠ è½½æµç¨‹
> - requireå¦‚ä½•åŠ è½½å†…ç½®æ¨¡å—ï¼Ÿ   loadNativeModule
> - requireå¦‚ä½•åŠ è½½node_modulesæ¨¡å—ï¼Ÿ
> - requireä¸ºä»€ä¹ˆä¼šå°†éjs/json/nodeæ–‡ä»¶è§†ä¸ºjsè¿›è¡ŒåŠ è½½

- requireæºç 
> 1. æˆ‘ä»¬ä»  require('./ejs')  è¿™è¡Œä»£ç åœ¨webStormä¸­å¼€å§‹è°ƒè¯•ã€‚ï¼ˆç‚¹å‡»step into ï¼‰
> 1. æ‰“å¼€ Scripts --> no domain --> internal --> modules --> cjs -->  helpers.js
> 1. return mod.require(path);   ----> line of 77 [helpers.js]
> 
![image.png](./images/0604.png)
>    1. è¿™é‡Œçš„modå°±æ˜¯æŒ‡Moduleå¯¹è±¡ï¼Œè°ƒè¯•åæ¯ä¸ªå­—æ®µå«ä¹‰ä¸ºï¼š
>       1. idï¼šæºç æ–‡ä»¶è·¯å¾„
>       1. path:æºç æ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶å¤¹,é€šè¿‡path.dirname(id)ç”Ÿæˆ
>       1. exportsï¼šæ¨¡å—è¾“å‡ºçš„å†…å®¹ï¼Œé»˜è®¤ä¸º{}
>       1. parentï¼šçˆ¶æ¨¡å—ä¿¡æ¯
>       1. filename:æºç æ–‡ä»¶è·¯å¾„
>       1. loadedï¼šæ˜¯å¦å·²ç»åŠ è½½å®Œæ¯•
>       1. childrenï¼šå­æ¨¡å—å¯¹è±¡é›†åˆ
>       1. pathsï¼šæ¨¡å—æŸ¥è¯¢èŒƒå›´
>    2. ç»§ç»­step intoåˆ°ä¸‹ä¸€æ­¥ï¼Œè¿›å»Moduleå¯¹è±¡çš„requireæ–¹æ³•
> 


> 4. ä»£ç å¦‚ä¸‹:   (æ ¡éªŒå‚æ•°ä¸º stringç±»å‹ä¸”ä¸ä¸ºç©º)

```javascript
Module.prototype.require = function(id) {
  validateString(id, 'id');
  if (id === '') {
    throw new ERR_INVALID_ARG_VALUE('id', id,
                                    'must be a non-empty string');
  }
  requireDepth++;
  try {
    return Module._load(id, this, /* isMain */ false);
  } finally {
    requireDepth--;
  }
};

```

> 5. Module._load(id,this,false) :
> - idï¼šä¼ å…¥çš„å­—ç¬¦ä¸²
> - thisï¼šModuleå¯¹è±¡
> - isMain:flaseè¡¨ç¤ºåŠ è½½çš„ä¸æ˜¯ä¸€ä¸ªä¸»æ¨¡å—

```javascript
Module._load = function(request, parent, isMain) {
  let relResolveCacheIdentifier;
  if (parent) {
    debug('Module._load REQUEST %s parent: %s', request, parent.id);
    relResolveCacheIdentifier = `${parent.path}\x00${request}`;
    const filename = relativeResolveCache[relResolveCacheIdentifier];
    if (filename !== undefined) {
      const cachedModule = Module._cache[filename];
      if (cachedModule !== undefined) {
        updateChildren(parent, cachedModule, true);
        return cachedModule.exports;
      }
      delete relativeResolveCache[relResolveCacheIdentifier];
    }
  }
  // âœ¨âœ¨âœ¨ 
  // Module._resolveFilenameæ˜¯require.resolve()çš„æ ¸å¿ƒå®ç°ï¼Œåœ¨lernaæºç è®²è§£æ—¶å­¦è¿‡--> Module._resolveLookupPaths()
  const filename = Module._resolveFilename(request, parent, isMain);

  const cachedModule = Module._cache[filename];
  if (cachedModule !== undefined) {
    updateChildren(parent, cachedModule, true);
    return cachedModule.exports;
  }
  //âœ¨âœ¨âœ¨
  // loadNativeModule ä¸­ åŠ è½½å†…ç½®æ¨¡å—ï¼Œè¿›å…¥è¯¥æºç :é€šè¿‡NativeModule.mapæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„å†…ç½®æ¨¡å—
  const mod = loadNativeModule(filename, request, experimentalModules);
  if (mod && mod.canBeRequiredByUsers) return mod.exports;

  // ä¸æ˜¯å†…ç½®æ¨¡å—ï¼Œnew Moduleï¼Œå…¶ä¸­childrenåœ¨newçš„æ—¶å€™å®Œæˆ
  const module = new Module(filename, parent);

  if (isMain) {
    process.mainModule = module;
    module.id = '.';
  }

  Module._cache[filename] = module;
  if (parent !== undefined) {
    relativeResolveCache[relResolveCacheIdentifier] = filename;
  }

  let threw = true;
  try {
    if (enableSourceMaps) {
      try {
        module.load(filename);
      } catch (err) {
        rekeySourceMap(Module._cache[filename], err);
        throw err; /* node-do-not-add-exception-line */
      }
    } else {
      // ğŸŒŸğŸŒŸğŸŒŸï¼šæ¨¡å—åŠ è½½
      module.load(filename);
    }
    threw = false;
  } finally {
    if (threw) {
      delete Module._cache[filename];
      if (parent !== undefined) {
        delete relativeResolveCache[relResolveCacheIdentifier];
      }
    }
  }

  return module.exports;
};

```


#### 8-2 requireåŠ è½½æ¨¡å—åŸç†è¯¦è§£


> ä¸Šä¸€èŠ‚æˆ‘ä»¬èµ°åˆ°äº†Module._load(filename)


```javascript
Module.prototype.load = function(filename) {
  debug('load %j for module %j', filename, this.id);

  assert(!this.loaded);
  
  // this.filenameä¸ºä¸Šä¸€èŠ‚newçš„æ—¶å€™å®šä¹‰çš„filename
  this.filename = filename;
  
  // ä»è¿™ä¸ªæ–‡ä»¶çš„æ–‡ä»¶ç›®å½•å¼€å§‹æŸ¥åˆ°ï¼Œæ‹¿åˆ°æ‰€æœ‰çš„å¯èƒ½æœ‰node_modulesçš„è·¯å¾„
  this.paths = Module._nodeModulePaths(path.dirname(filename));

  // æ‹¿åˆ°è¯¥æ–‡ä»¶åçš„åç¼€ï¼šè¿›å…¥è¯¥æ–¹æ³•å¯ä»¥çœ‹åˆ°å®šä¹‰çš„åŠ è½½çš„åç¼€åæœ‰å››ç§ï¼šjs json node mjs
  const extension = findLongestRegisteredExtension(filename);
  // allow .mjs to be overridden
  if (filename.endsWith('.mjs') && !Module._extensions['.mjs']) {
    throw new ERR_REQUIRE_ESM(filename);
  }
  // è¿™é‡Œå°±æ˜¯requireæ¨¡å—åŠ è½½çš„çœŸæ­£é€»è¾‘ï¼ŒåŒ…å« js node json,æºç å†…å®¹è§ä¸‹
  Module._extensions[extension](this, filename);
  this.loaded = true;

  if (experimentalModules) {
    const ESMLoader = asyncESM.ESMLoader;
    const url = `${pathToFileURL(filename)}`;
    const module = ESMLoader.moduleMap.get(url);
    // Create module entry at load time to snapshot exports correctly
    const exports = this.exports;
    // Called from cjs translator
    if (module !== undefined && module.module !== undefined) {
      if (module.module.getStatus() >= kInstantiated)
        module.module.setExport('default', exports);
    } else {
      // Preemptively cache
      // We use a function to defer promise creation for async hooks.
      ESMLoader.moduleMap.set(
        url,
        // Module job creation will start promises.
        // We make it a function to lazily trigger those promises
        // for async hooks compatibility.
        () => new ModuleJob(ESMLoader, url, () =>
          new ModuleWrap(url, undefined, ['default'], function() {
            this.setExport('default', exports);
          })
        , false /* isMain */, false /* inspectBrk */)
      );
    }
  }
};

```

Module._extensions[extension](this,filename)
```javascript
Module._extensions['.js'] = function(module, filename) {
  if (filename.endsWith('.js')) {
    const pkg = readPackageScope(filename);
    // Function require shouldn't be used in ES modules.
    if (pkg && pkg.data && pkg.data.type === 'module') {
      const parentPath = module.parent && module.parent.filename;
      const packageJsonPath = path.resolve(pkg.path, 'package.json');
      throw new ERR_REQUIRE_ESM(filename, parentPath, packageJsonPath);
    }
  }
  
  //contentå†…å®¹å°±æ˜¯æˆ‘ä»¬åŠ è½½çš„ejs/index.jsé—®çš„å†…å®¹ï¼Œè¿™é‡Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²
  const content = fs.readFileSync(filename, 'utf8');
  
  // æ‹¿åˆ°ejs.index.jsä¸­çš„å†…å®¹ï¼ŒModuleåŸå‹é“¾ä¸Šæ‰§è¡Œ_compile,ä»£ç å¦‚ä¸‹ï¼š
  module._compile(content, filename);
};
```

```javascript
Module.prototype._compile = function(content, filename) {
  let  moduleURL;
  let redirects;
  if (manifest) {
    moduleURL = pathToFileURL(filename);
    redirects = manifest.getRedirector(moduleURL);
    manifest.assertIntegrity(moduleURL, content);
  }

  maybeCacheSourceMap(filename, content, this);
  const compiledWrapper = wrapSafe(filename, content, this);

  var inspectorWrapper = null;
  if (getOptionValue('--inspect-brk') && process._eval == null) {
    if (!resolvedArgv) {
      // We enter the repl if we're not given a filename argument.
      if (process.argv[1]) {
        try {
          resolvedArgv = Module._resolveFilename(process.argv[1], null, false);
        } catch {
          // We only expect this codepath to be reached in the case of a
          // preloaded module (it will fail earlier with the main entry)
          assert(ArrayIsArray(getOptionValue('--require')));
        }
      } else {
        resolvedArgv = 'repl';
      }
    }

    // Set breakpoint on module start
    if (resolvedArgv && !hasPausedEntry && filename === resolvedArgv) {
      hasPausedEntry = true;
      inspectorWrapper = internalBinding('inspector').callAndPauseOnStart;
    }
  }
  const dirname = path.dirname(filename);
  const require = makeRequireFunction(this, redirects);
  let result;
  const exports = this.exports;
  const thisValue = exports;
  const module = this;
  if (requireDepth === 0) statCache = new Map();
  if (inspectorWrapper) {
    result = inspectorWrapper(compiledWrapper, thisValue, exports,
                              require, module, filename, dirname);
  } else {
    result = compiledWrapper.call(thisValue, exports, require, module,
                                  filename, dirname);
  }
  hasLoadedAnyUserCJSModule = true;
  if (requireDepth === 0) statCache = null;
  return result;
};

```

#### 8-3 requireåŠ è½½å†…ç½®æ¨¡å—å’Œå››ç§æ–‡ä»¶ç±»å‹åŸç†

1. åŠ è½½å†…ç½®æ¨¡å—ï¼šæµç¨‹åˆ° loadNativeModuleç»“æŸã€‚
1. åŠ è½½node_modulesæ¨¡å—ï¼šé€šè¿‡ Module._resolveFilename(request, parent, isMain)æ‰¾åˆ°è·¯å¾„ã€‚
1. åŠ è½½ä¸å­˜åœ¨æ¨¡å—ï¼šModule._resolveFilenameä¸­æŠ›å‡ºå¼‚å¸¸ã€‚
1. åŠ è½½.js/.json/.node/mjsæ–‡ä»¶ï¼šModule._extensions['XXX' ]
1. åŠ è½½å…¶å®ƒæ–‡ä»¶åç¼€åï¼šé»˜è®¤æŒ‰jsæ‰§è¡Œ


#### 8-4 requireç¼“å­˜æœºåˆ¶è§£æå’ŒCommonJSåŠ è½½ä¸»æ¨¡å—åŸç†


> è¿ç»­åŠ è½½ä¸¤æ¬¡åŒä¸€ä¸ªæ–‡ä»¶ï¼Œrequireæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ
> A: requireçš„ç¼“å­˜æœºåˆ¶ï¼Œä½¿å¾—åœ¨ç¬¬äºŒæ¬¡åŠ è½½ç›¸åŒçš„æ–‡ä»¶æ—¶ï¼Œä¸ä¼šå†æ¬¡æ‰§è¡Œæºæ–‡ä»¶ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­å»æ‹¿ã€‚ 

CommonJSåŠ è½½ä¸»æ¨¡å—æµç¨‹ï¼š  
> - require('internal/modules/cjs/loader').Module.runMain(process.argv[1]);
> - Module._load(main, null, true);
> - module.load(filename);
> - Module._extensions[extension](this, filename);
> - module._compile(content, filename);
> 
ä¸requireçš„åŒºåˆ«ä¸ºï¼šisMainä¸ºtrueï¼Œparentä¸ºnull

#### 8-5 requireåŸç†æ€»ç»“å’Œå›é¡¾

> - `relativeResolveCache[relResolveCacheIdentifier] `æŸ¥è¯¢ç¼“å­˜è·¯å¾„
> - `Module._cache[filename] `æŸ¥è¯¢ç¼“å­˜æ¨¡å—
> - `Module._resolveFilename `æŸ¥è¯¢æ¨¡å—çš„çœŸå®è·¯å¾„
> - `Module._resolveFilename `æŸ¥è¯¢æ¨¡å—çš„çœŸå®è·¯å¾„
> - `new Module `å®ä¾‹åŒ– Module å¯¹è±¡
> - `module.load(filename) `åŠ è½½æ¨¡å—
> - `findLongestRegisteredExtension `è·å–æ–‡ä»¶åç¼€
> - `Module._extensions[extension](this, filename) `è§£ææ¨¡å—å¹¶æ‰§è¡Œæ¨¡å—
> - `module._compile `ç¼–è¯‘æ¨¡å—ä»£ç 
> - `compileFunction `å°†æ¨¡å—ä»£ç ç”Ÿæˆå¯æ‰§è¡Œå‡½æ•°
> - `exports, require, module, filename, dirname `ç”Ÿæˆå…¥å‚
> - `compiledWrapper.call `æ‰§è¡Œæ¨¡å—å‡½æ•°
> - `return module.exports` è¾“å‡ºæ¨¡å—è¿”å›ç»“æœ
